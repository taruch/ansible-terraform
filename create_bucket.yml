---
- name: Create a Unique AWS S3 Bucket
  hosts: localhost
  connection: local
  gather_facts: true
  environment:
    AWS_ACCESS_KEY_ID: "{{ lookup('ansible.builtin.env', 'AWS_ACCESS_KEY_ID') }}"
    AWS_SECRET_ACCESS_KEY: "{{ lookup('ansible.builtin.env', 'AWS_SECRET_ACCESS_KEY') }}"
  vars:
    terraform_state_bucket: "aap-tf-bucket-5abacb29-72ff-48ac-afeb-ec4f3cf6f0d7"

  tasks:
    # - name: Generate a unique bucket name with a timestamp
    #   ansible.builtin.set_fact:
    #     terraform_state_bucket: "{{ bucket_prefix }}-{{ ansible_date_time.iso8601_basic_short | lower }}"

    - name: Display AWS credentials for debugging
      ansible.builtin.debug:
        msg: >
          AWS_ACCESS_KEY_ID: {{ lookup('ansible.builtin.env', 'AWS_ACCESS_KEY_ID') }}
          AWS_SECRET_ACCESS_KEY: {{ lookup('ansible.builtin.env', 'AWS_SECRET_ACCESS_KEY') }}

    - name: Display the generated bucket name
      ansible.builtin.debug:
        msg: "Attempting to create bucket: {{ terraform_state_bucket }}"

    - name: Create the S3 bucket with the unique name
      amazon.aws.s3_bucket:
        name: "{{ terraform_state_bucket }}"
        state: present
        region: "us-east-2"
        # By default, new buckets have all public access blocked.
        # This is the recommended secure default.
      register: s3_bucket_result

    - name: Output the bucket creation result
      ansible.builtin.debug:
        var: s3_bucket_result

...
